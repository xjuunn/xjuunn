[toc]

# 事件循环

事件循环时JavaScript中实现**非阻塞**、**异步编程**的核心机制。因为JS是单线程的，意味着它一次只能做一件事。为了处理诸如计时器、网络请求、用户交互等异步操作而不阻塞主线程，浏览器或Nodejs引擎使用了一种无限循环的机制，不断检查两个队列：**调用栈**和任务队列。

事件循环的基础主责就是：当调用栈为空时，将任务队列中的第一个任务推入调用栈执行。

## 相关概念

1. 调用栈：一个先进先出(LIFO)的数据结构，用于**跟踪当前正在执行的函数**。代码执行时，函数被推入栈顶，执行完毕后从栈顶弹出。
2. Web APIs(浏览器环境) / C++ APIs(Nodejs)：JS引擎本身无法处理异步操作，当遇到这些代码时，会将其交给浏览器的其他线程(Web API)去处理，执行完毕后会将对应的回调函数放入任务队列中。
3. 任务队列：一个先进先出(FIFO)的数据结构，用于存放等待执行的回调函数，它分为两种：
   * 宏任务队列：包含`setTimeout`、`setInterval`、`SetImmediate`、I/O操作、UI渲染，事件回调等。
   * 微任务队列：包含`Promise.then()`、`Promise.catch()`、`Promise.finally()`、`MutationObserver`、`queueMicrotask()`等。

## 循环过程

事件循环的每一次迭代，称为一个**tick**

1. 首先清空调用栈，执行当前的同步代码。
2. 当调用栈为空后，事件循环会优先检查微任务队列，并依次执行队列中的所有微任务，知道微任务队列完全清空。
3. 然后事件循环会在宏任务队列中取出第一个任务(如一个setTimout的回调)推入调用栈执行。
4. 在执行这个宏任务的过程中，可能又会产生微任务或宏任务。每当调用栈再次被清空时，事件循环会再次优先处理所有已存在的微任务，然后再进行下一个宏任务。

> 一次事件循环 --> 执行一个宏任务，然后执行所有微任务。微任务拥有比宏任务高得多的优先级。