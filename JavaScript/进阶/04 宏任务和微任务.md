[toc]

# 宏任务和微任务

## 宏任务(Macrotask) - 粗粒度的任务单元

宏任务代表了浏览器为了保持执行顺序而划分的一个个独立的工作单元。可以理解为：*新的一轮事件循环的起点*。

脚本执行(Script标签)、定时器操作、IO操作、用户交互事件、UI渲染都是宏任务

事件循环每次从宏任务队列中取出一个任务执行，然后就会去执行微任务队列。

## 微任务(Microtask) - 细粒度的即时任务

微任务是在当前宏任务执行结束后、下一个宏任务开始前，**立即执行**的小任务。他们的设计初衷是为了对异步操作做出更快速、更及时的反应，通常与Promise这类API紧密相关。

Promise回调、queueMicrotask()、MutationObserver等都是微任务。

微任务队列拥有极高的优先级。只要当前调用栈清空(即一个宏任务执行完)，事件循环就会连续、彻底地清空整个微任务队列，期间新加入的微任务也会一并执行，知道队列为空，才会继续进行渲染或处理下一个宏任务。

## 执行顺序和规则

1. 执行完所有的同步代码(当前宏任务)
2. 然后立即清空整个微任务队列(包括执行过程中新产生的微任务)
3. 必要时进行页面渲染
4. 最后再取出下一个宏任务执行

